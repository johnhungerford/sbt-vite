package sbtvite.sbtplugin

import org.scalajs.jsenv.Input
import org.scalajs.sbtplugin.ScalaJSPlugin
import org.scalajs.sbtplugin.ScalaJSPlugin.autoImport.*
import sbt.*
import sbt.Keys.*
import sbt.nio.Keys.{fileInputs, fileOutputs}

import java.nio.file.Path
import scala.util.Try

object SbtVitePlugin extends AutoPlugin {

  // The user should have to enable to plugin explicitly
//  override def trigger = allRequirements
  override def requires = ScalaJSPlugin

  object autoImport {
    lazy val testBundleDirectory = settingKey[Path]("Path of test bundle generated by vite")
    lazy val testViteConfigPath = settingKey[Path]("Path of vite configuration used to bundle " +
	  "tests")

    lazy val generateViteTestConfig = taskKey[Unit]("Generate vite configuration for bundling " +
	  "test JS sources into executable test script")
    lazy val bundleTestJS = taskKey[Unit]("Run vite on test JS sources to generate an executable " +
	  "test script")
  }

  import autoImport.*

  override lazy val projectSettings = Seq(
    Test / jsEnvInput := List(Input.Script((Test / testBundleDirectory).value / "main.js")),
    Test / testBundleDirectory := {
      val targetDir = target.value.toPath.toAbsolutePath
      val scalaSegment = "scala-" + scalaVersion.value
      targetDir / scalaSegment / s"${name.value}-test-bundle"
    },
    Test / testViteConfigPath := target.value.toPath / "vite-configs" / s"vite.config-test-${name
	  .value}.js",
    generateViteTestConfig / fileInputs += {
      (Test / fastLinkJS / scalaJSLinkerOutputDirectory).value.toPath.toString + "/*.js"
    },
    generateViteTestConfig := {
       if (generateViteTestConfig.inputFileChanges.hasChanges) {
          val rootDir = file(".").toPath.toAbsolutePath
          val linkOutputDir = (Test / fastLinkJS / scalaJSLinkerOutputDirectory).value.toPath
																				.toAbsolutePath
          val configString =
             s"""
                |import { defineConfig } from "vite";
                |import scalaJSPlugin from "@scala-js/vite-plugin-scalajs";
                |import react from '@vitejs/plugin-react';
                |
                |import sourcemaps from 'rollup-plugin-sourcemaps';
                |
                |export default defineConfig((env) => {
                |  const conf = defineConfig({
                |    root: "${rootDir}",
                |    mode: 'development',
                |    plugins: [
                |      react(),
                |    ],
                |    build: {
                |      cssCodeSplit: false,
                |      minify: false,
                |      chunkSizeWarningLimit: 100000,
                |      reportCompressedSize: false,
                |      sourcemap: true,
                |      rollupOptions: {
                |        treeshake: false,
                |        input: "${rootDir.relativize(linkOutputDir) / "main.js"}",
                |        output: {
                |          entryFileNames: `[name].js`,
                |          chunkFileNames: `[name].js`,
                |          assetFileNames: `[name].[ext]`,
                |          dir: "${(Test / testBundleDirectory).value}",
                |        },
                |        plugins: [sourcemaps()],
                |      },
                |    },
                |  });
                |  // console.log(conf);
                |  return conf;
                |});""".stripMargin
          val configPath = (Test / testViteConfigPath).value
          IO.write(configPath.toFile, configString)
       } else {}
    },
    generateViteTestConfig := (generateViteTestConfig dependsOn (Test / fastLinkJS)).value,
    generateViteTestConfig / fileOutputs ++= Seq(
       (Test / testViteConfigPath).value.toString,
       (Test / fastLinkJS / scalaJSLinkerOutputDirectory).value.toPath.toString + "/*.js",
    ),
    bundleTestJS := {
       if (
         generateViteTestConfig.outputFileChanges.hasChanges
             || Try(IO.read(((Test / testBundleDirectory).value / "main.js").toFile)).isFailure
       ) {
         generateViteTestConfig.value
         val configPath = (Test / testViteConfigPath).value.toString
          import scala.sys.process.*
          val command = s"vite build -c $configPath --mode=development"
          val builder = Process(command, Some(file(".")), "NODE_ENV" -> "development")
          println("\n" + command + "\n")
          val exitValue = builder.run().exitValue()
          if (exitValue != 0)
             throw new MessageOnlyException("Vite failed to build test bundle")
       } else {}
    },
    Test / test := ((Test / test) dependsOn bundleTestJS).value,
  )

  override lazy val buildSettings = Seq()

  override lazy val globalSettings = Seq()
}
